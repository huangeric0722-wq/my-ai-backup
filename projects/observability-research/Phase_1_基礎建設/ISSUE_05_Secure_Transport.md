# ISSUE_05: 環境隔離下的 Log 傳輸研究報告

| 角色 | 基礎建設科長 |
| :--- | :--- |
| 版本 | v1.0 |
| 日期 | 2026-02-07 |
| 狀態 | 已完成 |

---

## 1. 研究目標
在高度隔離的網路環境（如 DMZ、金融內部專網、甚至實體隔離網段）中，建立一套兼顧**安全性（Security）**與**可靠性（Reliability）**的日誌匯送機制。重點在於如何在不破壞隔離原則的前提下，將散落於各區域的日誌穩定傳輸至中心化觀測平台。

---

## 2. 架構設計：代理 (Proxy) 與 緩衝 (Buffering)

### 2.1 代理架構 (Agent-Proxy Architecture)
在嚴格限制 Outbound 流量的環境，直接讓每台主機連向中央日誌伺服器會造成防火牆規則過於臃腫。
*   **設計模式**：
    *   **Edge Collector**：在隔離區內部署輕量級收集器（如 Filebeat）。
    *   **Aggregation Proxy**：在隔離區邊緣部署 Logstash 或特定 Proxy（如 SOCKS5 / HTTP Proxy）。
*   **優點**：
    *   **收斂出口**：防火牆僅需對單一 Proxy IP 開通特定的 Outbound 端口。
    *   **協定轉換**：可將隔離區內的非加密流量在 Proxy 端封裝為 TLS。

### 2.2 中繼緩衝機制 (Broker-based Relaying)
針對流量高峰或網路不穩定的情境，引入訊息佇列作為中繼站。
*   **中繼選型**：
    *   **Kafka**：適用於高吞吐量、多訂閱者的場景，具備極強的持久化與回溯能力。
    *   **Redis (List/Stream)**：適用於輕量級、低延遲的快取場景，但在掉電或記憶體溢出時風險較高。
*   **緩衝邏輯**：
    *   日誌先行寫入本地端緩衝（Local Spooling）。
    *   Proxy 將日誌推送到位於「半開放區（Transitional Zone）」的 Kafka 集群。
    *   中心端再由 Consumer 從 Kafka 拉取日誌，實現生產者與消費者的完全解耦。

---

## 3. 特殊場景：單向傳輸 (Data Diode) 環境
在極高安全等級環境（如核能、國防、極核心帳務），可能存在物理性的單向傳輸設備。
*   **挑戰**：TCP 三向交握失效，傳統傳輸協定（HTTP/Logstash-Forwarder）無法運作。
*   **應對方案**：
    *   **UDP 封裝**：將日誌切片並封裝為 UDP 封包傳送。
    *   **FEC (Forward Error Correction)**：在發送端增加冗餘編碼，確保接收端即使丟包也能還原數據。
    *   **專屬轉發器**：在 Diode 兩端部署專用的 Forwarder 與 Receiver，模擬 ACK 機制或進行完整性校驗。

---

## 4. 給 Eric 的實作建議：最小化開通原則

針對網路安全性與防火牆管理，建議遵循以下實作步驟：

1.  **收斂存取點**：
    *   禁止所有隔離區主機直接外連。
    *   僅允許隔離區內的 `Log-Proxy` 節點存取外部。
2.  **限定通訊協定與端口**：
    *   嚴格限制為 `TCP/TLS 443` 或 `9092 (Kafka)`。
    *   日誌傳輸必須強制啟用 **TLS 雙向認證 (mTLS)**，防止非授權數據注入。
3.  **異地備援與背壓處理**：
    *   配置 Filebeat 的 `max_backoff` 與 `spool_size`，防止網路中斷時導致主機磁碟撐爆。
    *   設置日誌生命週期管理（ILM），優先保留關鍵性安全審核日誌。
4.  **監控與告警**：
    *   必須監控 Proxy 的處理延遲（Latency）與隊列深度（Queue Depth）。
    *   若隔離區邊緣發生日誌堆積，需即時告警以避免日誌遺失。

---

## 5. 總結
在隔離環境下，日誌傳輸應採取「**內部匯聚、單點外傳、中繼緩衝、加密加密再加密**」的核心策略。透過 Proxy 減少防火牆負擔，並藉由 Kafka 等機制緩衝確保數據不遺失，最後以 mTLS 確保傳輸管道的純淨與安全。

---
*文件編號：INFRA-RPT-20260207-001*